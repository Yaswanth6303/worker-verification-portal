<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Service - SkillVerify</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Playfair+Display:wght@600;700&display=swap"
        rel="stylesheet" />

    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Custom Stylesheets -->
    <link rel="stylesheet" href="../css/variables.css" />
    <link rel="stylesheet" href="../css/custom.css" />
</head>

<body class="bg-light">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top navbar-light bg-white shadow-sm" id="mainNavbar">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="../index.html">
                <div class="logo-icon bg-primary text-white rounded-3 d-flex align-items-center justify-content-center"
                    style="width: 44px; height: 44px">
                    <i class="ph-fill ph-shield-check fs-4"></i>
                </div>
                <div class="d-flex flex-column">
                    <span class="fw-bold fs-5">Skill<span class="text-primary">Verify</span></span>
                </div>
            </a>
            <div class="d-flex align-items-center gap-3">
                <a href="customer-dashboard.html" class="btn btn-outline-secondary rounded-pill">
                    <i class="ph ph-arrow-left me-1"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 100px; margin-bottom: 60px;">
        <div class="row g-4 justify-content-center">
            <!-- Sidebar: Worker Summary -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm rounded-4 position-sticky" style="top: 100px;">
                    <div class="card-body p-4 text-center">
                        <div class="mb-3">
                            <div class="mx-auto bg-light rounded-circle d-flex align-items-center justify-content-center overflow-hidden"
                                style="width: 100px; height: 100px;" id="workerAvatar">
                                <i class="ph-fill ph-user fs-1 text-muted"></i>
                            </div>
                        </div>
                        <h4 class="fw-bold mb-1" id="workerName">Loading...</h4>
                        <div class="d-flex align-items-center justify-content-center gap-2 mb-3">
                            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-1 rounded-pill"
                                id="workerService">Service</span>
                        </div>

                        <div class="d-flex justify-content-center gap-4 text-center mb-4">
                            <div>
                                <h5 class="fw-bold mb-0" id="workerRating">0.0</h5>
                                <small class="text-muted">Rating</small>
                            </div>
                            <div class="vr"></div>
                            <div>
                                <h5 class="fw-bold mb-0" id="workerReviews">0</h5>
                                <small class="text-muted">Reviews</small>
                            </div>
                            <div class="vr"></div>
                            <div>
                                <h5 class="fw-bold mb-0" id="workerExp">0</h5>
                                <small class="text-muted">Exp (Yrs)</small>
                            </div>
                        </div>

                        <div class="alert alert-light border text-start d-flex gap-2">
                            <i class="ph-fill ph-info text-primary mt-1"></i>
                            <small class="text-muted">You are booking a verified professional. Payment will be handled
                                after service completion.</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Form -->
            <div class="col-lg-7">
                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-body p-4 p-md-5">
                        <h3 class="fw-bold mb-4">Complete your Booking</h3>

                        <form id="bookingPageForm">
                            <input type="hidden" id="bookingWorkerId" name="workerId">
                            <input type="hidden" id="bookingMainService" name="mainService">

                            <!-- Service Selection -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Select Service Type</label>
                                <div class="d-flex flex-column gap-2" id="subServiceList">
                                    <!-- Populated via JS -->
                                    <div class="text-center py-3">
                                        <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                                        <span class="ms-2 text-muted">Loading services...</span>
                                    </div>
                                </div>
                                <div class="invalid-feedback d-block" id="serviceError"></div>
                            </div>

                            <!-- Date & Time -->
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Preferred Date</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0"><i
                                                class="ph ph-calendar"></i></span>
                                        <input type="date" class="form-control bg-light border-0 py-2" id="bookingDate"
                                            required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Preferred Time</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0"><i
                                                class="ph ph-clock"></i></span>
                                        <input type="time" class="form-control bg-light border-0 py-2" id="bookingTime"
                                            required>
                                    </div>
                                </div>
                            </div>

                            <!-- Description -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Description / Special Instructions</label>
                                <textarea class="form-control bg-light border-0" id="bookingDescription" rows="3"
                                    placeholder="Describe the issue or specific work needed..." required></textarea>
                            </div>

                            <!-- Address -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Service Address</label>
                                <textarea class="form-control bg-light border-0" id="bookingAddress" rows="2"
                                    placeholder="Enter complete address" required></textarea>
                            </div>

                            <!-- Price Summary -->
                            <div class="card bg-primary bg-opacity-10 border-0 p-3 mb-4">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-semibold text-primary">Estimated Price</span>
                                    <span class="fw-bold fs-4 text-primary" id="totalPrice">₹0</span>
                                </div>
                                <small class="text-muted mt-1">*Final price may vary based on inspection.</small>
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg w-100 rounded-pill py-3 fw-bold">
                                Confirm Booking
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Service Data Configuration
        const SERVICE_CATALOG = {
            'Plumbing': [
                { name: 'General Plumbing', price: 500, desc: 'Minor repairs and checks' },
                { name: 'Leak Fix', price: 800, desc: 'Fixing pipe or tap leaks' },
                { name: 'Pipe Installation', price: 1500, desc: 'New pipe fitting per unit' },
                { name: 'Basin/Sink Repair', price: 600, desc: 'Unclogging or fixing sinks' },
                { name: 'Water Motor Repair', price: 1200, desc: 'Pump analysis and minor fix' }
            ],
            'Electrical': [
                { name: 'General Visit', price: 300, desc: 'Inspection and minor fault detection' },
                { name: 'Fan Installation', price: 400, desc: 'Ceiling or wall fan mounting' },
                { name: 'Switchboard Repair', price: 500, desc: 'Replacing sockets or switches' },
                { name: 'Wiring Check', price: 1000, desc: 'Complete house wiring inspection' },
                { name: 'Inverter Installation', price: 800, desc: 'Battery and inverter setup' }
            ],
            'Painting': [
                { name: 'Interior Touchup', price: 2000, desc: 'Per room touchup painting' },
                { name: 'Full Room Painting', price: 5000, desc: 'Standard size room, single coat' },
                { name: 'Wall Texture', price: 3500, desc: 'Per wall accent texture' },
                { name: 'Waterproofing', price: 4000, desc: 'Chemical treatment per wall' },
                { name: 'Wood Polishing', price: 1500, desc: 'Door or window polishing' }
            ],
            'Cleaning': [
                { name: 'Full Home Deep Clean', price: 3000, desc: '2BHK complete cleaning' },
                { name: 'Kitchen Deep Clean', price: 1200, desc: 'Chimney, cabinets, and floor' },
                { name: 'Bathroom Cleaning', price: 800, desc: 'Tiles, sanitization, and scaling' },
                { name: 'Sofa Cleaning', price: 600, desc: 'Per seat shampoo cleaning' },
                { name: 'Carpet Cleaning', price: 500, desc: 'Dry vacuuming and shampoo' }
            ],
            'Carpentry': [
                { name: 'Furniture Repair', price: 500, desc: 'Chair, table, or bed minor fixes' },
                { name: 'Door Latch/Lock', price: 400, desc: 'Installation or repair' },
                { name: 'Custom Shelves', price: 1200, desc: 'Mounting and basic fabrication' },
                { name: 'Furniture Assembly', price: 800, desc: 'Assembling new furniture' }
            ],
            'HVAC': [
                { name: 'AC Service', price: 600, desc: 'Filter cleaning and gas check' },
                { name: 'AC Installation', price: 1500, desc: 'Split AC mounting and connection' },
                { name: 'Gas Refill', price: 2500, desc: 'Refrigerant top-up' },
                { name: 'Repair Visit', price: 400, desc: 'Diagnosis of cooling issues' }
            ]
        };

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Auth Check
            if (!Auth.isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }

            // 2. Parse Params
            // 2. Parse Params
            const urlParams = new URLSearchParams(window.location.search);
            const workerId = urlParams.get('workerId');
            const serviceType = urlParams.get('service');
            const workerName = urlParams.get('workerName');

            if (!workerId || !serviceType) {
                console.error('Missing Params:', { workerId, serviceType });
                alert('Invalid booking details: Missing worker ID or service type.');
                return;
            }

            document.getElementById('bookingWorkerId').value = workerId;
            document.getElementById('bookingMainService').value = serviceType;

            // Set Worker Name
            if (workerName) {
                const nameEl = document.getElementById('workerName');
                if (nameEl) nameEl.textContent = workerName;
            }

            // 3. Pre-fill User Info
            const user = Auth.getUser();
            if (user && user.address) {
                document.getElementById('bookingAddress').value = user.address;
            }

            // 4. Update UI
            document.getElementById('workerService').textContent = serviceType.charAt(0).toUpperCase() + serviceType.slice(1);

            // Render Services (Handle Case Sensitivity)
            // Capitalize first letter to match catalog keys
            const normalizedService = serviceType.charAt(0).toUpperCase() + serviceType.slice(1).toLowerCase();
            renderSubServices(normalizedService);

            // 5. Handle Form Submit call
            document.getElementById('bookingPageForm').addEventListener('submit', handleBookingSubmit);
        });

        function renderSubServices(mainService) {
            const container = document.getElementById('subServiceList');
            container.innerHTML = '';

            // Try exact match or fallback to normalized
            let subServices = SERVICE_CATALOG[mainService];

            // If not found, try to find a key that case-insensitively matches
            if (!subServices) {
                const key = Object.keys(SERVICE_CATALOG).find(k => k.toLowerCase() === mainService.toLowerCase());
                if (key) subServices = SERVICE_CATALOG[key];
            }

            // Default if still not found
            if (!subServices) {
                subServices = [{ name: 'General Consultation', price: 0, desc: 'Price determined after visit' }];
            }

            subServices.forEach((sub, index) => {
                const checkId = `service_${index}`;
                // Use checkboxes instead of radios
                const html = `
                    <div class="card border mb-2 service-card-item">
                        <div class="card-body p-3">
                            <div class="form-check d-flex justify-content-between align-items-center w-100 m-0">
                                <div>
                                    <input class="form-check-input" type="checkbox" name="selectedSubServices" 
                                        id="${checkId}" value="${sub.name}" data-price="${sub.price}"
                                        onchange="updateTotal()">
                                    <label class="form-check-label ms-2 cursor-pointer" for="${checkId}">
                                        <span class="fw-bold d-block">${sub.name}</span>
                                        <small class="text-muted">${sub.desc}</small>
                                    </label>
                                </div>
                                <span class="fw-bold text-primary">₹${sub.price}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function updateTotal() {
            const checkboxes = document.querySelectorAll('input[name="selectedSubServices"]:checked');
            let total = 0;
            checkboxes.forEach(cb => {
                total += parseInt(cb.dataset.price) || 0;
            });
            document.getElementById('totalPrice').textContent = `₹${total}`;
        }

        async function handleBookingSubmit(e) {
            e.preventDefault();

            // Validate Service Selection
            const selectedServices = Array.from(document.querySelectorAll('input[name="selectedSubServices"]:checked'));
            if (selectedServices.length === 0) {
                alert('Please select at least one service type.');
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            // Gather Data
            const workerId = document.getElementById('bookingWorkerId').value;
            const mainService = document.getElementById('bookingMainService').value;

            // Combine selected service names
            const subServiceNames = selectedServices.map(cb => cb.value).join(', ');
            const fullServiceName = `${mainService} (${subServiceNames})`;

            // Calculate Total Amount
            let amount = 0;
            selectedServices.forEach(cb => {
                amount += parseInt(cb.dataset.price) || 0;
            });

            const formData = {
                workerId: workerId,
                service: fullServiceName,
                description: document.getElementById('bookingDescription').value,
                scheduledDate: document.getElementById('bookingDate').value,
                scheduledTime: document.getElementById('bookingTime').value,
                address: document.getElementById('bookingAddress').value,
                amount: amount
            };

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/bookings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...Auth.getAuthHeader()
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    // Show success directly or redirect
                    window.location.href = 'customer-dashboard.html';
                } else {
                    alert(data.message || 'Booking failed');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Confirm Booking';
                }
            } catch (error) {
                console.error('Booking Error', error);
                alert('Something went wrong');
            }
        }
    </script>
</body>

</html>